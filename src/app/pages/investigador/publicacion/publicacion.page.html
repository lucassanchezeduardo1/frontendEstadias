<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/investigador" icon="chevron-back-outline"></ion-back-button>
    </ion-buttons>
    <ion-title>Nueva Investigación</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="form-container">
    <form [formGroup]="publicacionForm" (ngSubmit)="onSubmit()" class="form-card">
      
      <div class="section-title">
        <ion-icon name="information-circle-outline"></ion-icon>
        <span>Información General</span>
      </div>

      <div class="form-group">
        <ion-label position="stacked">Título de la Investigación <span class="required">*</span></ion-label>
        <ion-input type="text" formControlName="titulo" placeholder="Ej. El impacto de la IA en la medicina moderna"></ion-input>
        <div class="error-msg" *ngIf="publicacionForm.get('titulo')?.touched && publicacionForm.get('titulo')?.errors?.['required']">
          El título es obligatorio
        </div>
      </div>

      <div class="form-row">
        <div class="form-group half">
          <ion-label position="stacked">Categoría <span class="required">*</span></ion-label>
          <ion-select placeholder="Seleccionar" interface="popover" formControlName="categoria_id">
            <ion-select-option *ngFor="let cat of categorias" [value]="cat.id">{{cat.nombre}}</ion-select-option>
          </ion-select>
        </div>
        <div class="form-group half">
          <ion-label position="stacked">Sub-categoría <span class="required">*</span></ion-label>
          <ion-input type="text" formControlName="sub_categoria" placeholder="Ej. Biotecnología"></ion-input>
        </div>
      </div>

      <div class="form-group">
        <ion-label position="stacked">Colaboradores</ion-label>
        <ion-input type="text" formControlName="colaboradores" placeholder="Nombres separados por comas"></ion-input>
      </div>

      <div class="section-title">
        <ion-icon name="image-outline"></ion-icon>
        <span>Multimedia</span>
      </div>

      <div class="form-group">
        <ion-label position="stacked">Imagen de Portada <span class="required">*</span></ion-label>
        <input type="file" #imgInput (change)="onImgSelected($event)" accept="image/*" hidden>
        <div class="upload-box" (click)="imgInput.click()" [class.has-preview]="imgPreview">
          <div *ngIf="!imgPreview" class="upload-content">
            <ion-icon name="image-outline"></ion-icon>
            <span>Seleccionar Imagen</span>
          </div>
          <img *ngIf="imgPreview" [src]="imgPreview" class="preview-img">
        </div>
      </div>

      <div class="section-title">
        <ion-icon name="document-text-outline"></ion-icon>
        <span>Contenido y Síntesis</span>
      </div>

      <div class="form-group">
        <ion-label position="stacked">Archivo PDF <span class="required">*</span></ion-label>
        <input type="file" #pdfInput (change)="onPdfSelected($event)" accept="application/pdf" hidden>
        <div class="upload-box dashed" (click)="pdfInput.click()" [class.has-file]="selectedPdf">
          <ion-icon [name]="selectedPdf ? 'document-check-outline' : 'document-outline'"></ion-icon>
          <span>{{ selectedPdf ? selectedPdf.name : 'Subir Archivo PDF' }}</span>
        </div>
      </div>

      <div class="form-group">
        <ion-label position="stacked">Síntesis del Investigador <span class="required">*</span></ion-label>
        <ion-textarea rows="6" formControlName="sintesis_investigador" 
          placeholder="Escribe aquí un resumen detallado de tu investigación (mínimo 500 caracteres)...">
        </ion-textarea>
        <div class="char-count" [class.error]="publicacionForm.get('sintesis_investigador')?.value?.length < 500">
          {{ publicacionForm.get('sintesis_investigador')?.value?.length || 0 }}/500 mínimo
        </div>
      </div>

      <div class="form-group ai-summary-box" *ngIf="isGeneratingAiSummary || publicacionForm.get('sintesis_ia')?.value">
        <ion-label position="stacked" color="primary">
          <ion-icon name="sparkles"></ion-icon> Síntesis Generada por IA
        </ion-label>
        <div class="ai-content" *ngIf="!isGeneratingAiSummary">
          {{ publicacionForm.get('sintesis_ia')?.value }}
        </div>
        <div class="ai-loading" *ngIf="isGeneratingAiSummary">
          <ion-spinner name="dots"></ion-spinner>
          <span>Procesando PDF...</span>
        </div>
      </div>

      <div class="section-title">
        <ion-icon name="link-outline"></ion-icon>
        <span>Referencias y Enlaces</span>
      </div>

      <div class="form-group">
        <ion-label position="stacked">Links de Referencia</ion-label>
        <ion-input type="url" formControlName="links_referencia" placeholder="https://..."></ion-input>
      </div>

      <div class="form-group">
        <ion-label position="stacked">Videos (URL)</ion-label>
        <ion-input type="url" formControlName="videos_url" placeholder="https://youtube.com/..."></ion-input>
      </div>

      <div class="submit-container">
        <ion-button expand="block" type="submit" [disabled]="publicacionForm.invalid || !selectedPdf || !selectedImg" class="submit-btn" shape="round">
          <ion-icon name="cloud-upload-outline" slot="start"></ion-icon>
          Publicar Investigación
        </ion-button>
      </div>
      
    </form>
  </div>
</ion-content>