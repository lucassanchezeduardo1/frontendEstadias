<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-title>Inicio</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="main-container">

    <!-- Barra de búsqueda -->
    <div class="search-section">
      <ion-searchbar placeholder="Buscar publicaciones..." (ionInput)="buscar($event)" class="custom-search" mode="ios"
        animated="true">
      </ion-searchbar>
    </div>

    <div class="section-block">
      <div class="section-header">
        <div class="section-title-group">
          <h2 class="section-title">Categorías</h2>
        </div>
      </div>

      <div class="skeleton-row" *ngIf="cargandoCategorias">
        <div class="skeleton-card" *ngFor="let s of [1,2,3,4]"></div>
      </div>

      <div class="error-state" *ngIf="errorCategorias && !cargandoCategorias">
        <ion-icon name="cloud-offline-outline"></ion-icon>
        <p>No se pudieron cargar las categorías.</p>
        <ion-button fill="outline" size="small" color="danger" (click)="cargarCategorias()">
          Reintentar
        </ion-button>
      </div>

      <div class="horizontal-scroll" *ngIf="!cargandoCategorias && !errorCategorias">
        <!-- Chip "Todas" -->
        <div class="category-card all-card" [class.selected]="!categoriaSeleccionada"
          (click)="categoriaSeleccionada = null; aplicarFiltro()">
          <div class="cat-icon-wrapper">
            <ion-icon name="grid-outline"></ion-icon>
          </div>
          <span class="cat-name">Todas</span>
        </div>

        <!-- Categorías dinámicas -->
        <div class="category-card" *ngFor="let cat of categorias" [style.background]="cat.color"
          [class.selected]="categoriaSeleccionada?.id === cat.id" (click)="seleccionarCategoria(cat)">
          <div class="cat-icon-wrapper">
            <ion-icon [name]="cat.icono"></ion-icon>
          </div>
          <span class="cat-name">{{ cat.nombre }}</span>
          <span class="cat-check" *ngIf="categoriaSeleccionada?.id === cat.id">
            <ion-icon name="checkmark-circle"></ion-icon>
          </span>
        </div>
      </div>

      <!-- Sin categorías -->
      <div class="empty-categories" *ngIf="!cargandoCategorias && !errorCategorias && categorias.length === 0">
        <ion-icon name="folder-open-outline"></ion-icon>
        <p>No hay categorías disponibles.</p>
      </div>

      <!-- Botón de Favoritos -->
      <div class="actions-row" *ngIf="!cargandoCategorias">
        <button class="fav-nav-btn" (click)="irAFavoritos()">
          <ion-icon name="heart"></ion-icon>
          Mis Favoritos
        </button>
      </div>
    </div>

    <!-- Filtro activo de categoría -->
    <div class="active-filter" *ngIf="categoriaSeleccionada">
      <ion-chip class="filter-chip" [style.--background]="'rgba(128,0,32,0.1)'">
        <ion-icon name="pricetag-outline" color="danger"></ion-icon>
        <ion-label>{{ categoriaSeleccionada.nombre }}</ion-label>
        <ion-icon name="close-circle" (click)="categoriaSeleccionada = null; aplicarFiltro()" color="danger"></ion-icon>
      </ion-chip>
    </div>


    <div class="section-block">
      <div class="section-header">
        <div class="section-title-group">
          <h2 class="section-title">
            {{ categoriaSeleccionada ? categoriaSeleccionada.nombre : 'Publicaciones' }}
          </h2>
        </div>
        <span class="count-badge">{{ publicacionesFiltradas.length }}</span>
      </div>

      <div class="pub-skeleton" *ngIf="cargandoPublicaciones">
        <div class="skeleton-pub-card" *ngFor="let s of [1,2,3]"></div>
      </div>

      <div class="error-state" *ngIf="errorPublicaciones && !cargandoPublicaciones">
        <ion-icon name="cloud-offline-outline"></ion-icon>
        <p>No se pudieron cargar las publicaciones.</p>
        <ion-button fill="outline" size="small" color="danger" (click)="cargarPublicaciones()">
          Reintentar
        </ion-button>
      </div>

      <!-- Sin publicaciones -->
      <div class="empty-state"
        *ngIf="!cargandoPublicaciones && !errorPublicaciones && publicacionesFiltradas.length === 0">
        <ion-icon name="document-text-outline"></ion-icon>
        <p>No se encontraron publicaciones{{ categoriaSeleccionada ? ' en esta categoría' : '' }}.</p>
      </div>

      <div class="publications-feed" *ngIf="!cargandoPublicaciones && !errorPublicaciones">
        <div class="publication-card" *ngFor="let pub of publicacionesFiltradas">

          <!-- Imagen de portada -->
          <div class="card-image" [style.background-image]="'url(' + getImagenUrl(pub.id) + ')'"
            (click)="verDetalle(pub.id)">
            <div class="image-overlay"></div>
            <div class="card-badge">{{ pub.categoria?.nombre || 'General' }}</div>
            <div class="card-date-overlay">{{ formatearFecha(pub.created_at) }}</div>

            <!-- Icono de Favorito -->
            <button class="heart-btn" [class.is-favorite]="pub.esFavorito" (click)="toggleFavorito($event, pub)">
              <ion-icon [name]="pub.esFavorito ? 'heart' : 'heart-outline'"></ion-icon>
            </button>
          </div>

          <!-- Cuerpo de la card -->
          <div class="card-body">
            <h3 class="card-titulo">{{ pub.titulo }}</h3>

            <div class="card-autor">
              <div class="autor-avatar">
                <ion-icon name="person-outline"></ion-icon>
              </div>
              <div class="autor-info">
                <span class="autor-label">Investigador principal</span>
                <span class="autor-nombre">
                  {{ pub.investigador_principal?.nombre || '' }} {{ pub.investigador_principal?.apellidos || '' }}
                </span>
              </div>
            </div>

            <!-- Subcategorías -->
            <div class="field-group" *ngIf="pub.sub_categoria">
              <div class="field-label">
                <ion-icon name="pricetags-outline"></ion-icon>
                <span>Subcategorías</span>
              </div>
              <div class="chips-row">
                <span class="chip chip-sub" *ngFor="let sub of parseLista(pub.sub_categoria)">
                  {{ sub }}
                </span>
              </div>
            </div>

            <!-- Colaboradores -->
            <div class="field-group" *ngIf="pub.colaboradores">
              <div class="field-label">
                <ion-icon name="people-outline"></ion-icon>
                <span>Colaboradores</span>
              </div>
              <div class="chips-row">
                <span class="chip chip-colab" *ngFor="let colab of parseLista(pub.colaboradores)">
                  {{ colab }}
                </span>
              </div>
            </div>

            <!-- Footer: estadísticas -->
            <div class="card-footer">
              <ion-button fill="clear" class="btn-leer-mas" size="small" (click)="verDetalle(pub.id)">
                Leer más
                <ion-icon slot="end" name="arrow-forward-outline"></ion-icon>
              </ion-button>
              <div class="card-stats">
                <span class="stat-item">
                  <ion-icon name="eye-outline"></ion-icon>
                  {{ pub.vistas || 0 }}
                </span>
                <span class="stat-item">
                  <ion-icon name="download-outline"></ion-icon>
                  {{ pub.descargas || 0 }}
                </span>
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>

  </div>
</ion-content>